#!/usr/bin/env coffee
_ = require 'pg-promise'
query = (e)->console.log e.query
pgp = _ {query}

argParser = require './src/arg-parser'
{dbname, srid, schema, tiles} = argParser()

console.log(dbname, srid, schema)

{QueryFile} = pgp
{readFileSync} = require 'fs'

connection = null
if dbname? and dbname.startsWith("postgresql://")
  connection = dbname

if not connection?
  connection = "postgresql:///#{dbname}"

db = pgp(connection)

params = {schema, srid}
procedure = QueryFile "#{__dirname}/db-fixtures/create-tables.sql", {params}

do ->
  try
    await db.query "SELECT count(*) FROM ${schema~}.linework", {schema}
    process.exit()
  catch err
    console.log("Tables not found, creating...")

  try
    await db.query procedure
  catch err
    console.error err
  process.exit()
